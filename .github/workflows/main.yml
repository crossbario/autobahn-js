name: Autobahn JS CI v2

on:
  workflow_dispatch:
  push:
    branches:
      - $default-branch
  pull_request:
    branches:
      - $default-branch

jobs:
  unittest:
    env:
      CB_IMAGE: crossbario/crossbar:cpy-slim-amd64-22.7.1.dev1
      CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}

    runs-on: ubuntu-latest
    strategy:
      matrix:
        node: [lts/*]

    name: Node ${{ matrix.node }} run
    steps:
    - uses: actions/checkout@v4
    - uses: actions/setup-node@v4
      with:
        node-version: ${{ matrix.node }}

    # Run this a bit early in the CI, so we don't have to "sleep".
    - name: Run crossbar
      run: |
        docker run --rm --entrypoint=/usr/local/bin/crossbar $CB_IMAGE version
        docker run -d -v $PWD/.crossbar:/node -p 8080:8080 -p 8090:8090 -u $UID --entrypoint=/usr/local/bin/crossbar $CB_IMAGE start --cbdir /node

    - name: Install dependencies
      run: |
        cd packages/autobahn
        npm install

    - name: Run tests
      run: |
        cd packages/autobahn
        npm run test

    - name: Upload coverage reports to Codecov via GitHub Actions
      if: env.CODECOV_TOKEN != ''
      uses: codecov/codecov-action@v5
      with:
        directory: packages/autobahn/coverage

    - name: Skip uploading coverage reports to Codecov via GitHub Actions
      if: env.CODECOV_TOKEN == ''
      run: echo "Upload skipped. CODECOV_TOKEN is not defined. Add it as a secret in your repository settings."