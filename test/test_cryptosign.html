<!DOCTYPE html>
<html>
   <body>
      <h1>Open JavaScript console to watch log output (hit F12)</h1>
      <script>AUTOBAHN_DEBUG = false;</script>
      <script src="../build/autobahn.js"></script>
      <script>
         console.log('running autobahn-js ' + autobahn.version);

         // the WebSocket-WAMP URL of Crossbar.io
         var url;
         if (document.location.origin == "file://") {
            url = "ws://127.0.0.1:9000/ws";

         } else {
            url = (document.location.protocol === "http:" ? "ws:" : "wss:") + "//" +
                        document.location.host + "/ws";
         }

         // the user email (used as authid)
         var authid = "tobias.oberstein@gmail.com";

         // this is fixed per app
         var private_key = "com.crossbario.fabric.key.seed";

         // the activation code must be set exactly once during exchange
         var activation_code = null;
         //var activation_code = "X9RE-7VWF-GPR5";

         // this is an optional feature (see below)
         var request_new_activation_code = false;

         // this will auto-generate a new key seed (a secret) and store that
         // in browser local storage if there isn't a key already
         var pkey = autobahn.auth_cryptosign.load_private_key(private_key);

         // this will create and configure a connection using WAMP-cryptosign authentication
         // the parameters are used as follows:
         //    - url: the ws(s) router URL (required)
         //    - authid: the user email (required for registration and during key activation)
         //    - pkey: the private key to be used (eg from load_private_key())
         //    - activation_code: The activation code to be used (only once!).
         //    - request_new_activation_code:
         var connection = autobahn.auth_cryptosign.create_connection(url, authid, pkey, activation_code, request_new_activation_code);

         // main app entry point
         connection.onopen = function (session, details) {
            console.log("Connected:", session.id, details);

            // HERE: place app code here.
         };

         // TODO: handle different failing cases appropriately in the app
         connection.onclose = function (reason, details) {

            // A WAMP-cryptosign authentication request can fail for various reasons:

            if (details.reason == 'fabric.auth-failed.pending-activation') {
               console.log("PENDING-ACTIVATION:", details.message);
               // there already was an activation request sent: hence, that is pending
               // and the client should authenticate but provide an activation token
               // in the authextra in addition to the regular WAMP-cryptosign challenge
               // signing thing. you can override this behavior when "request_new_activation_code"
               // is set to "true", which forces generating/sending a new activation token

            } else if (details.reason == 'fabric.auth-failed.new-user-auth-code-sent') {
               console.log("NEW-USER-AUTH-CODE-SENT:", details.message);
               // a new activation token has been sent to the user email

            } else if (details.reason == 'fabric.auth-failed.no-pending-activation') {
               console.log("NO-PENDING-ACTIVATION:", details.message);
               // an activation token was provided where none was expected

            } else {
               console.log("Connection lost: " + reason, details);
               // a different reason, unrelated to WAMP-cryptosign occurred
            }
         }

         // trigger actual opening of the connection
         connection.open();
      </script>
   </body>
</html>
